name: Create & Upload Discord Bot Docker Image to GHCR

on:
  push:
    branches: [main]
    paths:
      # only push to changes in apps/bot or other necessary images
      - "apps/bot/**"
      - "bot.Dockerfile"
      - "docker-compose*.yml" # docker compose files
      - ".github/workflows/deploy-bot.yml" # this file
      - ".github/actions/publish-docker-image/**" # Dependencies
      - "!*.md" # ignore markdown files

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ Checkout repo
        uses: actions/checkout@v2

      # Is this necessary?
      - name: âœï¸ Write bot-config.yml
        run: echo "{{ secrets.BOT_CONFIG_YML }}" > bot-config.yml

      - name: Build and deploy Bot
        # Directory name only
        uses: ./.github/actions/publish-docker-image
        with:
          service: "bot"
          repo_token: ${{ secrets.GITHUB_TOKEN }}

  update-server-image:
    name: Update Docker Image in Production
    runs-on: ubuntu-latest
    steps:
      - name: Info about Image
        run: |
          echo "Image name: Bot"
          docker image inspect ghcr.io/joshuanianji/treehouse-bot.server:latest | grep Created
